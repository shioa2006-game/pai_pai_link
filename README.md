# 牌牌連鎖 — ゲーム仕様書 & テストカバレッジ ＋ 不具合更新プロンプト

このドキュメントは、**現行実装のゲームメカニズム（パズル＋麻雀）**と、**自動テストのカバー範囲**をまとめた README に、運用用の**不具合更新プロンプト**を付録として収めたものです。  
（Tキーで `06_ppl.test.js` を実行すると、ブラウザのコンソールにテスト結果が出ます）

```
index.html
01_ppl.config.js   # 設定（描画/速度/偏り/CPU方針）
02_ppl.mahjong.js  # 麻雀の厳密判定（14枚/プール）＋プレビュー
03_ppl.cpu.js      # CPU和了（軽探索＋厳密フォールバック）＋採点
04_ppl.core.js     # 盤面/山札/偏りデッキ/連鎖/遷移/完全落下/入力
05_ppl.ui.js       # 牌描画/盤面/HUD/配置モーダル/HOLD/リザルト
06_ppl.test.js     # 自動テスト（Tキー実行・コンソール出力）
```

---

## 1. ゲーム概要（要点）

- **盤面**：6×12 の格子（セルは正方形）。  
- **落下**：2枚1組のペアを左右/回転/加速で操作して着地。  
- **消去**：**同スート（萬/筒/索/字）の4連結以上**（上下左右4近傍）を検出・除去。  
- **連鎖**：重力→消去を繰り返し、消しが起きる限り継続。  
- **回収→配置**：連鎖で消した牌を回収→**配置モーダル**で「手牌/捨て牌」に振り分け（手牌は**14枚上限**）。  
- **HOLD**：配置確定後に**結果確認**（プレイヤー/CPUの和了判定と加点）。  
- **終了**：山札（136枚）が尽き、ペア供給不可になった瞬間に**自動最終判定**を1回行い、合計点で勝敗。

---

## 2. タイル表現（UI要点）

- **正方形の牌**をCanvasで描画。**ダブル枠**（外枠＋内枠）。  
- **赤ドラ**は**数字のみ赤**。  
- **萬子の「萬」文字は常に赤**（数字は赤ドラのみ赤）。  
- 字牌は「東南西北 白發中」を日本語文字で描画。  
- モーダルでは**手牌=青枠／捨て牌=赤枠**で明示。

---

## 3. 山札（136枚固定）と「絶妙な偏り」（A+B）

### 3.1 構成
- 萬/筒/索：各スート 1～9 の**4枚**（**5は各スート1枚だけ赤ドラ**）  
- 字牌：東南西北 白發中 の**各4枚**  
→ 合計 **136枚**。配分は**固定**。

### 3.2 供給（SuitPlanner：**順序のみ制御**）
- 4スート別バケットにシャッフルして保持。  
- **毎ペア**の供給前に、「**同色ペアにするか（A）**」「**主スート選択と走り抑制（B）**」を決定し、該当バケットから**無復元**で取り出す。

**A：ゾロ（同色ペア）率の短期均し**  
- 直近 `BIAS_WINDOW_PAIRS`（既定16）で観測したゾロ率を、目標 `BIAS_ZORO_TARGET`（0.24）へ**負帰還**で寄せる。  
- 上下限：`BIAS_ZORO_MIN/MAX`。在庫2未満のスートしか無い場合は**強制非ゾロ**。

**B：走り（主スート連発）抑制**  
- 同じ主スートが `BIAS_MAX_STREAK`（既定2）続いたら、そのスート重みを `BIAS_STREAK_PENALTY`（0.2倍）で減衰。  
- 在庫比率に `BIAS_REMAINING_GAMMA`（1.2）を掛け、枯渇と偏りを緩和。  
- 微小ノイズ `BIAS_NOISE_EPS` で同率時の揺らぎを付与。

> ✅ **配分は不変**／**順序のみ**調整。短期は“素直”、長期は“読み切れない”手触り。

---

## 4. 連鎖・スコア・完全落下

- **Tick駆動**：`CHAIN_TICK_MS` 間隔で「重力 → 消去」。  
- **連鎖スコア**：そのTickで消えた枚数 × 100 × 連鎖段数。  
- **完全落下の実施ポイント**  
  1) 連鎖収束→**配置モーダル**前  
  2) HOLDクローズ直後（CPUの盤面除去の後）  
  → **落下がなくなるまで**重力を反復。必要なら**再連鎖**。

---

## 5. 配置モーダル（手牌/捨て牌の振り分け）

- 連鎖収束後に開く。**獲得牌＋既存手牌**を「手牌/捨て牌」に切替。  
- **手牌14枚上限**（超過分は捨て牌へ）。  
- 確定後、**HOLD**へ遷移。

---

## 6. 麻雀ルール（和了判定と採点）

### 6.1 プレイヤー（厳密14枚のみ）
- **`MJ.solve14`**（完全探索＋メモ化）：**4面子＋雀頭**の14枚で完全消費できるか。  
- 赤牌は**優先復元**。  
- 採点：**2000 +（赤×1000）**。

### 6.2 CPU（盤面＋捨て牌のプール）
- プール合計が**14枚未満**なら不成立。  
- **二段構え**の `CPU.tryWin`：  
  1) **軽探索**（キー列でペア→4面子DFS）  
  2) **厳密フォールバック**（`MJ.solveFromPool` でプールから14枚抽出）  
- 返却（UI互換）：  
  - `pair`: `['man_5','man_5']` のような**キー文字列配列**  
  - `melds`: `{type:'triplet'|'sequence', keys:[...3]}` ×4  
  - `usedBoardTiles` / `usedDiscardTiles`（**実**タイル参照）  
- 採点：**2000 +（赤×1000）**。

### 6.3 HOLD後の盤面処理
- `CPU_CLEAR_POLICY: 'used-only'`（既定）  
  → CPUが使った**盤面牌だけ**除去。捨て牌はプールから参照一致で消費。  
- HOLDクローズ直後に**完全落下**→必要なら**再連鎖**。

---

## 7. 終了と自動最終判定

- NEXT＋山札の合計が**2枚未満**で供給不可 → **自動最終判定**を1回：  
  - プレイヤー：手牌**14枚ちょうど**なら判定。  
  - CPU：プール**14枚以上**なら判定。  
- その後 **GAME OVER**。`playerTotal` / `cpuTotal` 比較で勝敗。

---

## 8. 操作

- ← / →：横移動  
- Z / X：回転  
- ↓：落下加速（間隔 1/4）  
- **T**：自動テスト実行（結果はコンソール）  
- **R**：ゲームオーバー画面で再開  
- 任意キー：HOLD画面を閉じる

---

## 9. 主な設定（抜粋・01_ppl.config.js）

- 盤面/速度：`COLS/ROWS/CELL/CANVAS_*`, `FALL_INTERVAL_MS`, `CHAIN_TICK_MS`  
- 偏り：`BIAS_ENABLED`, `BIAS_WINDOW_PAIRS`, `BIAS_ZORO_TARGET/MIN/MAX`, `BIAS_ZORO_FEEDBACK`, `BIAS_MAX_STREAK`, `BIAS_STREAK_PENALTY`, `BIAS_REMAINING_GAMMA`, `BIAS_NOISE_EPS`  
- CPU：`CPU_CLEAR_POLICY`（'used-only' 推奨）  
- テスト：`TEST_ENABLED/TEST_SEED/TEST_VERBOSE/TEST_BIAS_SAMPLE_PAIRS`

---

## 10. 自動テスト（06_ppl.test.js）

### 実行
- `index.html` を開き、**T キー** → コンソールに `✅/❌` と計測時間、統計値（ゾロ率・主スート連続など）を表示。

### カバレッジ（守っている仕様）

| 区分 | テスト名 | 目的 / 担保している仕様 |
|---|---|---|
| ユニット（麻雀） | **MJ.solve14 基本形** | 厳密14枚で面子×4＋雀頭×1の成立 |
|  | **MJ.solve14 赤牌混在** | 赤混在でも成立し、復元 `hand` に赤が含まれる |
|  | **MJ.solveFromPool 14抽出** | プール（14～18枚）から厳密抽出で成立 |
| ユニット（偏り） | **偏り: ゾロ率＆連続抑制** | 観測ゾロ率が `target±許容`、主スート連続が `MAX_STREAK+1` を超えない |
| ユニット（盤面） | **盤面: 完全落下** | 完全落下後に浮遊ゼロ |
|  | **盤面: 4連結消去** | 4連結の正しい検出・除去 |
| CPU和了 | **CPU.tryWin 成功/枚数一致** | `usedBoard+usedDiscard == 14`、UI互換（pair/keys） |
|  | **CPU.tryWin 失敗(プール<14)** | 14枚未満はスキップ（`won=false, reason='pool<14'`） |
| 結合 | **結合: 連鎖→配置→HOLD** | 収束で **alloc**、確定で **hold**、初回更新で `playerHold`/`cpuHold` 評価 |
|  | **結合: CPU used-only 除去→落下** | 使った盤面牌だけ除去→完全落下→必要なら再連鎖 |
|  | **結合: 山切れ最終判定** | 供給不能で自動最終判定が1回走りゲーム終了 |

---

## 11. 運用ルール（テスト＆README更新）

- **ロジック変更**（偏り・重力・連鎖・HOLD・CPU和了・麻雀）→ **必ず**テスト追加/更新。  
- **設定既定値変更**（`BIAS_*`, `CPU_*`, `CHAIN_TICK_MS`）→ 統計/結合の閾値やケース見直し。  
- **バグ修正** → **回帰テスト**を追加（再発防止）。  
- **UIのみ** → 原則テスト不要（挙動に影響する変更を除く）。  
- 上記テストを更新する類のPRでは、**README（本書）も同時に更新**（次章「不具合例」に追記）。

---

## 12. 不具合例（履歴と再発防止）

> 新しい不具合を報告する際は、**ここに類似事例があるか確認**し、無ければ**テンプレに従って追記**してください（最下部の「不具合更新プロンプト」参照）。

### #BUG-2025-01 `k.startsWith is not a function`（HOLD UIでフリーズ）
- **症状**：CPU和了やHOLD画面でフリーズ。`startsWith` 例外。  
- **原因**：`pair` の形式が UI 期待（キー文字列配列）と不一致（牌オブジェクト配列など）。  
- **修正**：`CPU.tryWin` を **`pair: ['suit_n','suit_n']`** に統一。UIも `tileFromKey` を使用。  
- **再発防止**：**CPU.tryWin 成功/枚数一致** で **UI互換（pair/keys）** を検証。

### #BUG-2025-02 `removeTiles is not a function`（HOLD後に例外）
- **症状**：HOLDクローズ時に TypeError、画面が灰色。  
- **原因**：`Board.removeTiles` 未実装。  
- **修正**：参照一致で盤面から指定牌のみ除去する `removeTiles` を実装。  
- **再発防止**：**結合: CPU used-only 除去→落下** で除去→完全落下まで通ることを検証。

### #BUG-2025-03 HOLD画面で牌が宙に浮く（完全落下漏れ）
- **症状**：連鎖→配置→HOLD直後に浮遊牌が残る。  
- **原因**：モーダル前/クローズ後の**完全落下**呼び出し漏れ。  
- **修正**：`_settleBoardFully()` を配置前とHOLDクローズ後に実行。  
- **再発防止**：**盤面: 完全落下**／**結合: 連鎖→配置→HOLD** の通過で担保。

### #BUG-2025-04 片方だけスポーン（山残1枚時）
- **症状**：NEXT/Deckで片方だけ出る瞬間に不安定。  
- **原因**：`_pairBuf` と `draw()` の端枚処理不足。  
- **修正**：残り1枚時は**単発供給**、例外なしで遷移。  
- **再発防止**：**結合: 山切れ最終判定** で供給不能→終了までを確認。

### #BUG-2025-05 `this._countBySuit is not a function`（起動直後に灰色画面）
- **症状**：起動直後に例外で停止。  
- **原因**：`SuitPlanner` が `Deck` のメソッドを `this._countBySuit` と誤参照（正しくは `this.deck._countBySuit()`）。  
- **修正**：すべて **`this.deck.*`** に統一。  
- **再発防止**：**偏り: ゾロ率＆連続抑制** の初期化～ドローが通ることを担保。

### #BUG-2025-06 テスト「連鎖→配置→HOLD」だけ❌
- **症状**：他は緑、当該テストのみ失敗。  
- **原因**：`new Game()` 直後は `state='title'`。`play` にせず連鎖Tickを回していた。  
- **修正**：テストで **`g.state='play'` を明示**してTick進行。  
- **再発防止**：06_ppl.test.js 修正済み。

---
